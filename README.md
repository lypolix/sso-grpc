# SSO gRPC Сервер Аутентификации и Авторизации

## Оглавление
1. [Обзор проекта](#обзор-проекта)
2. [Архитектура системы](#архитектура-системы)
3. [Технологический стек](#технологический-стек)
4. [Протоколы и API](#протоколы-и-api)
5. [База данных](#база-данных)
6. [Безопасность](#безопасность)
7. [Интеграционные возможности](#интеграционные-возможности)
8. [Развертывание](#развертывание)
9. [Тестирование](#тестирование)
10. [Разработка](#разработка)

---

## Обзор проекта

SSO (Single Sign-On) gRPC сервер — централизованная система аутентификации и авторизации для микросервисной архитектуры. Сервер предоставляет единую точку входа, позволяя пользователям проходить аутентификацию один раз для доступа ко всем связанным сервисам.

**Функции:**  
- Централизованная аутентификация — единый вход для сервисов  
- Авторизация — управление ролями и правами  
- Управление сессиями — JWT токены  
- Администрирование пользователей и приложений  

---

## Архитектура системы

### Многослойная архитектура

- Транспортный слой: gRPC handlers
- Сервисный слой: бизнес-логика аутентификации
- Репозиторный слой: хранение данных через SQLite, интерфейсы
- Доменный слой: модели данных и контракты
- Инфраструктурный слой: конфигурация, логирование, миграции БД

### Компоненты системы

- gRPC сервер — обработка запросов
- Сервис аутентификации — логика регистрации и логина
- Хранилище данных — взаимодействие с SQLite
- JWT генератор — создание и проверка токенов
- Мигратор БД — управление схемой базы

---

## Технологический стек

- **Go 1.24+** — основной язык
- **gRPC + Protocol Buffers** — RPC протокол
- **SQLite** — встраиваемая база
- **JWT tokens** — stateless аутентификация
- **bcrypt** — хеширование паролей

### Ключевые библиотеки

- `google.golang.org/grpc` — RPC сервер и клиент
- `github.com/golang-jwt/jwt` — работа с токенами JWT
- `golang.org/x/crypto/bcrypt` — хеширование паролей
- `github.com/ilyakaznacheev/cleanenv` — загрузка конфигурации
- `github.com/golang-migrate/migrate` — миграции базы
- `github.com/mattn/go-sqlite3` — SQLite драйвер
- `github.com/brianvoe/gofakeit` — генератор тестовых данных
- `github.com/stretchr/testify` — assertions для тестов

---

## Протоколы и API

### gRPC API

Сервер предоставляет API c использованием protobuf-контрактов.

**Методы:**
- `Register` — регистрация пользователя
- `Login` — аутентификация
- `IsAdmin` — проверка административных прав

### Генерация кода

Клиентский и серверный gRPC-код генерируется автоматически из `.proto` файлов с помощью protoc.

### Репозиторий protobuf

Контракты хранятся в отдельном [protos_sso](https://github.com/lypolix/protos_sso):
- Централизованное управление
- Независимая версификация API
- Простая интеграция

---

## База данных

### Структура SQLite

**users:**  
- id (INTEGER PRIMARY KEY)  
- email (TEXT UNIQUE)  
- pass_hash (BLOB)  
- is_admin (BOOLEAN)

**apps:**  
- id (INTEGER PRIMARY KEY)  
- name (TEXT UNIQUE)  
- secret (TEXT UNIQUE)

### Миграции

- Последовательное применение изменений
- Откат изменений
- Версионность схемы

---

## Безопасность

### Меры защиты

- bcrypt c salt (стоимость 10) для паролей
- Prepared statements — защита от инъекций
- JWT с подписью (HS256)
- Валидация входных данных на всех уровнях
- Настраиваемый TTL токенов

### Защита от атак

- Brute-force — медленное хеширование
- Replay attacks — TTL токена
- Token theft — привязка токена к приложению
- Data injection — строгая валидация

---

## Интеграционные возможности

### Мульти-приложенная архитектура

- Регистрация разных приложений, каждый со своим секретом
- Единый сервер для разных сервисов

### Интеграция с clic-metric

Сервис [clic-metric](https://github.com/lypolix/clic-metric) использует данный SSO сервер для:
- Проверки пользователя для доступа к метрикам
- Авторизации операций
- Управления доступом к метрикам

### Сценарии использования

1. Единый вход для всех сервисов
2. Межсервисная проверка токенов
3. Централизованное управление правами пользователей

### Протоколы интеграции

- gRPC — нативный протокол
- REST API — через gRPC gateway
- Библиотеки клиентов — для разных языков

---

## Развертывание

### Локально
```
git clone https://github.com/lypolix/sso-grpc.git
cd sso-grpc
go mod download
go run cmd/migrator/main.go --storage-path=./storage/sso.db
go run cmd/sso-auth/main.go --config=./config/local.yaml
```

**Конфигурация:**
- YAML файлы
- Переменные окружения
- Значения по умолчанию

### Systemd
```
[Unit]
Description=SSO Auth Service
After=network.target
[Service]
Type=simple
ExecStart=/usr/local/bin/sso-auth --config=/etc/sso/config.yaml
Restart=always
[Install]
WantedBy=multi-user.target
```

---

## Тестирование

### Интеграционные тесты

- Честное тестирование сервиса
- Все компоненты запускаются в окружении теста
- Отправка реальных gRPC запросов

**Сценарии:**
- Успешный логин и регистрация
- Проверка дубликатов email
- Валидация входных данных
- Проверка admin прав
- Обработка ошибочных данных

### Test Suite

- Инициализация базы данных
- gRPC клиент
- Управление контекстом тестирования
```
go test ./internal/...
go test ./tests/...
go test -coverprofile=coverage.out ./...
```

---

## Разработка

### Структура проекта

sso-auth/
├── cmd/ # Исполняемые приложения
├── internal/ # Внутренние пакеты
│ ├── app/ # Инициализация приложения
│ ├── config/ # Конфигурация
│ ├── domain/ # Модели данных
│ ├── grpc/ # gRPC обработчики
│ ├── services/ # Бизнес-логика
│ └── storage/ # Работа с БД
├── migrations/ # SQL миграции
└── tests/ # Интеграционные тесты
text

### Принципы разработки

- Использование интерфейсов — гибкость и тестируемость
- Минималистичные интерфейсы — узкая область ответственности
- Dependency injection — явная передача зависимостей
- Structured logging — контекстное логирование
- Error wrapping — правильная обработка ошибок

### Мониторинг и логирование

- structured logging с контекстом
- gRPC метрики — количество запросов, время, статусы
- Отслеживание времени операций


## Заключение

SSO gRPC сервер — надёжное решение для централизованной аутентификации в микросервисной архитектуре, обеспечивающее производительность через gRPC, безопасность через JWT и bcrypt, а также простую интеграцию через protobuf. Проект активно развивается и поддерживает интеграцию с различными клиентами и сервисами, включая clic-metric для сбора метрик.
